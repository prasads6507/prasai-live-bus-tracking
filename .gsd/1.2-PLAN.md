# Phase 1.2 Plan: Manual Skip Stop

This plan transitions the "Skip Stop" logic from automatic proximity detection to a manual driver-controlled action with confirmation.

<task type="auto">
  <name>Modify Background Service Proximity Logic</name>
  <files>mobile/lib/features/driver/services/background_tracking_service.dart</files>
  <action>
    1. Update `_checkForSkip`: Disable the automatic Firestore update and FCM notification. 
    2. Instead, maybe just log that a stop *could* be skipped, but do not execute it.
    3. Ensure the background isolate continues to track distance to 'currentStop' so it can notify when ARRIVING/ARRIVED.
  </action>
  <verify>Observe logs that auto-skip is disabled.</verify>
  <done>Automatic skipping is disabled.</done>
</task>

<task type="auto">
  <name>Implement Manual Skip Event in Background Service</name>
  <files>mobile/lib/features/driver/services/background_tracking_service.dart</files>
  <action>
    1. Add a listener for a new 'skip_stop' event in the background isolate.
    2. When received, perform the Firestore updates (`currentIndex`, `skippedStopIds`, `buses.nextStopId`) and call `_notifyServer` with type `SKIPPED`.
    3. Update local `SharedPreferences` in the background isolate so the next proximity check uses the new `nextStopId`.
  </action>
  <verify>Invoke 'skip_stop' and verify Firestore update and FCM delivery.</verify>
  <done>Manual skip logic implemented in background service.</done>
</task>

<task type="auto">
  <name>Add Next Stop UI & Skip Button</name>
  <files>mobile/lib/features/driver/screens/driver_home.dart</files>
  <action>
    1. Add a state variable `_nextStopName` and `_nextStopId` in `_DriverContentState`.
    2. Update the `_locationUpdateSubscription` to receive these from the background isolate.
    3. Create a `NextStopCard` widget below the `AssignedBusCard`.
    4. Implement a "Skip Stop" button that:
       - Shows an `AlertDialog` confirmation.
       - If confirmed, calls `service.invoke('skip_stop', {'stopId': nextStopId})`.
  </action>
  <verify>Manually skip a stop from the UI and see the "Next Stop" update immediately.</verify>
  <done>Driver UI supports manual skipping.</done>
</task>
