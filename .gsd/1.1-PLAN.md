# Phase 1.1 Plan: Notification Refinement

This plan refines the notification system to ensure "Instant Boarding Alerts" are handled by the attendance endpoints, and "Trip End Alerts" (specifically for those who didn't board) are handled by the trip-end process, avoiding redundancy.

<task type="auto">
  <name>Consolidate Trip-End Alerts</name>
  <files>frontend/college-portal/server/controllers/notificationController.js</files>
  <action>
    Modify `sendTripEndedNotification`:
    1. Distinguish between 'Assigned' students and 'Favorite' students.
    2. For 'Assigned' students who ARE NOT in `attendedStudents`: Send a specific "⚠️ Attendance Alert: Not Boarded/Dropped Off" notification.
    3. For 'Favorite' students OR 'Assigned' students who DID board: Determine if a general "Trip Completed" notification is still needed (user seems to want to minimize noise, so we should probably only notify the absentees at this stage to satisfy the specific request).
    4. Implementation: Update the notification body dynamically based on attendance status.
  </action>
  <verify>Call `sendTripEndedNotification` with a mock trip and verify that students not in the attended list get the 'Attendance Alert' body.</verify>
  <done>Trip-end notifications are targeted and non-redundant.</done>
</task>

<task type="auto">
  <name>Clean up historyUpload Logic</name>
  <files>frontend/college-portal/server/controllers/driverController.js</files>
  <action>
    Modify `historyUpload`:
    1. Remove the manual FCM multicast block from `historyUpload` (lines 618-639).
    2. Reason: `sendTripEndedNotification` is already called at the end of every trip and is better suited to handle the logic of "who didn't board" by checking the final Firestore state.
  </action>
  <verify>End a trip and verify that a single 'Attendance Alert' is sent once to non-boarded students.</verify>
  <done>Redundant notification logic removed from driverController.</done>
</task>

<task type="auto">
  <name>Verify Instant Boarding Alerts</name>
  <files>frontend/college-portal/server/controllers/driverController.js</files>
  <action>
    Review `markPickup` and `markDropoff` to ensure there are no unawaited promises or bottlenecks.
    Ensure `sendStudentAttendanceNotification` is using the fast `messaging.send` (Individual) which is lower latency than multicast for single targets.
  </action>
  <verify>Manually trigger markPickup via Postman and observe immediate delivery.</verify>
  <done>Instant boarding alerts are verified for low-latency delivery.</done>
</task>
